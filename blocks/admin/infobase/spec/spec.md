#Определения
_Инфобаза_ это блок, который является надстройкой над PDO и предоставляет возможность создавать древовидные каталоги любой сложности, объединяя и устанавливая структуры таблиц и отношения между ними. Инфобазой также называют само объединение таблиц (напр. "инфобаза товаров"). Блок предоставляет удобный интерфейс для управлением контентом из панели администрирования. Стоит отметить, что инфобаза **не** является ORM или абстракцией от PDO, т.е. таблицы, создаваемые блоком _Инфобаза_ однозначно соответствуют реальным таблицам в базе данных и могут использоваться другими блоками без инфобазы напрямую. Система использует сервис Database, и изначально разрабатывалась для работы с SQLite.

Здесь и далее под _массивом_ подразумевается ассоциативный массив (в терминах JSON определяется с помощью конструкции "{...}"). Термином _список_ называется неассоциативный масив (в JSON определеляется как "[...]"). _Записью_ называется массив, извлекаемый из одной строки таблицы. _Запись_ всегда содержит поля id и sourceTable, однозначно определяющие её местоположение в базе.

Определения инфобаз находятся в таблице infobases, записи которой имеют следующие поля:

 - **id** Идентификатор
 - **url** Системное имя инфобазы (оно же часть URL)
 - **name** Имя инфобазы, отображаемое для пользователей
 - **prefix** Префикс таблиц, используемых инфобазой
 - **description** Описание инфобазы (HTML)
 - **structure** Структура инфобазы, описанная массивом в формате JSON. Ключи - имена таблиц без префикса (например, articles, categories, items...), значения - массивы, описывающие структуру записей в этих таблицах.
 - **changeAccessLevel** Минимальный уровень доступа для изменения
 - **readAccessLevel** Минимальный уровень доступа для чтения

Кстати, формат самой таблицы определен в ней же, в записи с id=1. Эта запись защищена от изменений.

#Массив, описывающий структуру записи
Ниже указан формат массива. В квадратные скобки заключены необязательные атрибуты.

 - **fields** массив описаний полей, где ключом служит имя поля в sql таблице, а значением - массив, описывающий поле.
 - **isRoot** может ли запись не иметь родителя (быть корневой), значения - true или false
 - [**childs**] список типов записей, которые могут быть потомками для описываемого типа || потомков нет
 - [**onCheck**] функция-обработчик события проверки. Будет вызвана перед проверкой записи. В качестве параметра получает саму запись, возвращает массив ошибок, либо пустой массив, если ошибок не обнаружено. Сохранение записи будет прервано если возвращаемый массив непустой. Ошибки будут выведены пользователю.
 - [**onSave**] функция-обработчик события сохранения. Будет вызвана перед тем, как сохранить запись (только если запись успешно прошла проверку). В качестве параметра получает саму запись. После сделанных изменений функция должна возвратить запись обратно.
 - [**onDelete**] функция-обработчик события удаления. Будет вызвана до удаления записи. В качестве параметра получает удаляемую запись, возвращает массив ошибок, либо пустой массив если ошибок не обнаружено. Удаление записи будет прервано если возвращаемый массив непустой. Ошибки будут выведены пользователю.

#Зарезервированные имена полей
Структура записи содержит атрибут fields, задающий массив, где ключом служит имя поля в sql таблице, а значением - массив, описывающий поле. Системой инфобаз зарезервированы следующие имена полей:

 - **id** Идентификатор. Это поле добавляется автоматически, поэтому прописывать его отдельно не нужно (это вызовет ошибку).
 - **name** Имя записи (удобное для вывода в интерфейсе). Должно быть строкой _string_ (см. ниже).
 - **url** URL записи. Используется для url-адресации в публичной части какталога. Должно быть строкой _string_. Если не заполнено, будет транслитерироваться из поля name. Если у записи нет поля "name", будет взято значение "id".
 - **parent** Идентификатор родительской записи. Должно быть указателем _foreignKey_.
 - **created** Дата создания (метка времени UNIX). Заполняется автоматически. Должно быть меткой времени _timestamp_.
 - **modified** Дата изменения (метка времени UNIX). Заполняется автоматически. Должно быть меткой времени _timestamp_.
 - **published** Дата публикации (метка времени UNIX). Заполняется пользователем. Система гарантирует, что время публикации дочерних записей будет не меньше, чем родительских. Должно быть меткой времени _timestamp_.
 - **recordType** Тип записи. Поле добавляется автоматически, при извлечении из таблицы, поэтому, не стоит давать полю такое имя, иначе его значение всегда будет затираться. 

#Массив, описывающий поле
Массив имеет обязательный ключ **type** (тип данных), от значения которого зависит, какие ключи нужно указать далее. Ниже описаны возможные значения и ключи для них. Ключи разделены на атрибуты и ограничители.

##integer
Целое число (SQLite integer)

атрибуты:
 - [**initial**] значение, присваиваемое при создании записи || 0
 - [**required**] обязательное или нет || false
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""

ограничители:
 - [**min**] минимальное значение || проверка не производится
 - [**max**] максимальное значение || проверка не производится

##real
Число с плавающей запятой (SQLite real)

атрибуты:
 - [**initial**] значение, присваиваемое при создании записи || 0.0
 - [**required**] обязательное или нет || false
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""
 - [**format**] формат для вывода через sprintf || выводится без sprintf

ограничители:
 - [**min**] минимальное значение || проверка не производится
 - [**max**] максимальное значение || проверка не производится

##string
Строка c автоматической обрезкой тегов (SQLite text)

атрибуты:
 - [**method**] способ ввода ("textarea" или "input") || "input"
 - [**initial**] значение, присваиваемое при создании записи || ""
 - [**required**] обязательное или нет || false
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""

ограничители:
 - [**min**] минимальная длина
 - [**max**] максимальная длина
 - [**pattern**] регулярное выражение PCRE

##code
Строка кода  (SQLite text). Редактируется с помощью модифицированного поля textarea с подсветкой синтаксиса или WYSIWYG

атрибуты:
 - **syntax** html | html-wysiwyg | javascript | php | css | json
 - [**multiline**] true | false || true
 - [**initial**] значение, присваиваемое при создании записи || ""
 - [**required**] обязательное или нет || false
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""

ограничители:
 - [**min**] минимальная длина
 - [**max**] максимальная длина

##files
Список файлов. Файлы загружаются в папку temp и при сохранении переносятся в папку /uploads/infobase/{имя таблицы}. Поэтому в поле не хранятся пути до файлов а только их имена. При удалении записи файлы связанные с ней будут также удалены. (SQLite text)

атрибуты:
 - [**initial**] значение, присваиваемое при создании записи || ""
 - [**required**] обязательное или нет || false
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""
 - [**rename**] генерировать ли новое имя файла || true

атрибуты только для файлов изображений (если файл не является изображением, система выведет ошибку, указанную атрибутом error):
 - [**cropTo**] обрезать картинку. Значение это список [длина, ширина]. Если одно из значений равно 0, картинка масштабируется без обрезки чтобы соответствовать другому (ненулевому) значению. Если оба значения ненулевые, картинка обрежется с минимальными возможными потерями. Если указано [0,0] файл сохранится в неизменном виде || [0,0]
 - [**makeThumbnail**] сделать превью картинки. Значение это список [длина, ширина]. /uploads/infobase/{имя таблицы}/thumbnails. Имя файла совпадает. Если одно из значений 0, то превью создано не будет. || не создавать превью

ограничители:
 - [**min**] минимальное количество файлов
 - [**max**] максимальное количество файлов
 - [**extensions**] массив разрешенных расширений
 - [**maxSize**] максимальный размер файла

##timestamp
Метка времени UNIX. Вводится в текстовое поле соответственно формату. (SQLite integer)

атрибуты:
 - [**initial**] значение, присваиваемое при создании записи || ""
 - [**required**] обязательное или нет || false
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""
 - [**format**] строка в формате функции date() || "dd.mm.YY"

ограничители:
 - [**relMin**] минимальное значение
 - [**relMax**] максимальное значение
 - [**absMin**] максимальное значение
 - [**absMax**] максимальное значение

##color
Цвет #RRGGBB. Вводится в input type=color. (SQLite text)

атрибуты:
 - [**initial**] значение, присваиваемое при создании записи || "#000000"
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""

ограничители не предусмотрены

##options
Список выбранных опций, хранится как строка с разделителями. (SQLite text)

атрибуты:
 - **method** "select"|"radio"|"checkbox"
 - **variants** список вариантов
 - [**required**] обязательное или нет (только для method=radio или select) || false
 - [**initial**] значение, присваиваемое при создании записи || ""
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""
 - [**separator**] разделитель || ","

ограничители (только для method=checkbox):
 - [**min**] минимальное кол-во выбранных опций
 - [**max**] максимальное кол-во выбранных опций
 - [**deprecated**] список запрещенных комбинаций (например, строка "рок,попса" запрещает одновременный выбор жанров "рок" и "попса").

##hash
Шестнадцатеричный хэш. (SQLite text)

атрибуты:
 - [**method**] "md5"|"sha256"|"haval160,4"|...или другие доступные для функции hash() || "md5"
 - [**nonEmptyPlaceholder**] Строка, отображающаяся как плейсхолдер, если значение задано || ""
 - [**required**] обязательное или нет || false
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""

ограничители:
 - [**min**] минимальная длина
 - [**max**] максимальная длина
 - [**pattern**] регулярное выражение PCRE (применяется до хеширования)

##foreignKey
Указатель на другую запись в формате типЗаписи-id Выбор производится с помощью виджета таблиц. (SQLite text)

атрибуты:
 - **availableRecordTypes** список возможных типов записей для этого поля
 - [**required**] проверять наличие ненулевого указателя || false
 - [**error**] сообщение об ошибке || ""
 - [**label**] текстовая подпись поля || ""
 - [**hint**] инструкция по заполнению || ""

ограничители не предусмотрены

##hiddenText
Скрытое текстовое поле. Скрытые поля не выводятся и не редактируются через блок "Инфобаза", но в таблицах существуют и могут быть изменены прямыми SQL-запросами (SQLite text)

атрибуты:
 - [**initial**] значение, присваиваемое при создании записи || ""

ограничители не предусмотрены

##hiddenInteger
Скрытое целое число (SQLite integer)

атрибуты:
 - [**initial**] значение, присваиваемое при создании записи || 0

ограничители не предусмотрены

##hiddenReal
Cкрытое число с плавающей точкой (SQLite real)

атрибуты:
 - [**initial**] значение, присваиваемое при создании записи || 0.0

ограничители не предусмотрены